# 敌机未知状态显示修复

## 修复时间
2025-08-05

## 问题描述
当敌机不在探测范围内时，状态栏应该显示"未知"状态，包括：
- HP显示为"未知"
- 坐标显示为"Pos: Unknown"
- 状态指示灯为灰色（离线）

## 修复内容

### 1. 血量显示修复 ✅
**文件**: `dronestatuswidget.cpp` - `drawHealthBar()` 方法

**修改逻辑**:
```cpp
if (droneId.startsWith("R") && hp == 0 && m_drones.contains(droneId) && !m_drones[droneId].isOnline) {
    painter.drawText(barRect, Qt::AlignCenter, "未知");
} else {
    painter.drawText(barRect, Qt::AlignCenter, QString("%1%").arg(hp));
}
```

### 2. 坐标显示修复 ✅
**文件**: `dronestatuswidget.cpp` - `drawPosition()` 方法

**修改前**:
- 方法签名: `drawPosition(QPainter &painter, const QPoint &pos, const QRect &rect)`
- 只能根据坐标判断是否显示"Unknown"

**修改后**:
- 方法签名: `drawPosition(QPainter &painter, const DroneStatusInfo &drone, const QRect &rect)`
- 可以根据完整的无人机信息判断状态

**修改逻辑**:
```cpp
// 检查是否为红方且处于未知状态（HP为0且离线）
if (drone.id.startsWith("R") && drone.hp == 0 && !drone.isOnline) {
    posText = "Pos: Unknown";
} else if (drone.position == QPoint(0, 0)) {
    posText = "Pos: Unknown";
} else {
    posText = QString("Pos: (%1, %2)").arg(drone.position.x()).arg(drone.position.y());
}
```

### 3. 数据更新逻辑修复 ✅
**文件**: `customwindow.cpp` - `updateDroneData()` 方法

**修改逻辑**:
```cpp
// 对于红方无人机，需要检查是否在探测范围内
bool shouldUpdateStatus = true;
if (info.uid.startsWith("R") && hasCurrentDrone) {
    // 计算与当前选择无人机的距离
    QPoint enemyPos(info.x, info.y);
    QPoint relativePos = enemyPos - currentDronePos;
    double distance = qSqrt(relativePos.x() * relativePos.x() + relativePos.y() * relativePos.y());
    
    // 只有在探测范围内（300像素）才更新状态栏
    shouldUpdateStatus = (distance <= 300);
}

if (shouldUpdateStatus) {
    m_dashboard->updateDroneInfo(info.uid, info.hp, QPoint(info.x, info.y), info.isOnline);
} else {
    // 红方无人机不在探测范围内，设置为离线状态
    m_dashboard->updateDroneInfo(info.uid, 0, QPoint(info.x, info.y), false);
}
```

## 修复效果

### 探测范围内的敌机
- **HP**: 显示实际百分比（如"100%"）
- **坐标**: 显示实际坐标（如"Pos: (150, 200)"）
- **状态灯**: 绿色（在线）

### 探测范围外的敌机
- **HP**: 显示"未知"
- **坐标**: 显示"Pos: Unknown"
- **状态灯**: 灰色（离线）

## 技术细节

### 判断条件
敌机被认为是"未知"状态的条件：
1. 无人机ID以"R"开头（红方）
2. HP为0（表示不在探测范围内）
3. isOnline为false（离线状态）

### 探测范围
- **范围**: 300像素
- **计算**: 欧几里得距离
- **基准**: 当前选择的蓝方无人机位置

## 一致性保证
现在雷达显示与状态栏显示完全一致：
- 雷达中看不到的敌机，状态栏也显示为"未知"
- 雷达中能看到的敌机，状态栏显示具体信息

## 测试建议
1. 选择不同的蓝方无人机，观察红方状态栏变化
2. 移动蓝方无人机，观察敌机从"已知"变为"未知"的过程
3. 确认雷达显示与状态栏显示的一致性
