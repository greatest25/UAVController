# 无人机控制台整体逻辑流程图

## 系统架构图

```mermaid
graph TB
    A[程序启动] --> B[CustomWindow 初始化]
    B --> C[创建 CustomDashboard]
    C --> D[初始化通信模块]
    D --> E[启动定时器]

    E --> F[控制定时器 50ms]
    E --> G[更新定时器 50ms]

    F --> H[发送控制命令]
    G --> I[更新UI显示]

    H --> J[QVsoaClient 通信]
    I --> K[更新各组件显示]

    J --> L[服务器响应]
    L --> M[数据处理]
    M --> N[更新数据存储]
    N --> K

    K --> O[MinimapWidget 更新]
    K --> P[RadarWidget 更新]
    K --> Q[CompassWidget 更新]
    K --> R[JoystickWidget 更新]
    K --> S[DroneStatusWidget 更新]
```

## 详细数据流图

```mermaid
graph LR
    subgraph "数据输入"
        A1[服务器数据] --> A2[JSON解析]
        A3[用户交互] --> A4[事件处理]
    end

    subgraph "数据处理"
        A2 --> B1[无人机数据]
        A2 --> B2[障碍物数据]
        A2 --> B3[游戏状态数据]
        A4 --> B4[控制命令]
    end

    subgraph "数据存储"
        B1 --> C1[m_dronesInfo Map]
        B2 --> C2[障碍物缓存]
        B3 --> C3[游戏状态变量]
    end

    subgraph "UI更新"
        C1 --> D1[MinimapWidget]
        C1 --> D2[RadarWidget]
        C1 --> D3[DroneStatusWidget]
        C2 --> D1
        C2 --> D2
        C3 --> D4[游戏状态显示]
    end

    subgraph "用户控制"
        D1 --> E1[点击选择无人机]
        D2 --> E2[雷达交互]
        E1 --> F1[更新选中无人机]
        E2 --> F2[雷达控制]
    end
```

## 组件交互图

```mermaid
graph TD
    subgraph "主窗口 CustomWindow"
        A[CustomWindow] --> B[CustomDashboard]
        A --> C[QVsoaClient]
        A --> D[定时器管理]
    end

    subgraph "仪表盘 CustomDashboard"
        B --> E[MinimapWidget]
        B --> F[RadarWidget]
        B --> G[CompassWidget]
        B --> H[JoystickWidget]
        B --> I[DroneStatusWidget]
        B --> J[FlightControlWidget]
    end

    subgraph "数据流"
        C --> K[服务器通信]
        K --> L[数据解析]
        L --> M[数据分发]
        M --> E
        M --> F
        M --> G
        M --> I
    end

    subgraph "用户交互"
        E --> N[地图点击]
        H --> O[摇杆控制]
        N --> P[无人机选择]
        O --> Q[飞行控制]
    end

    P --> R[更新选中状态]
    Q --> S[发送控制命令]
    R --> M
    S --> C
```

## 通信流程图

```mermaid
sequenceDiagram
    participant U as 用户
    participant CW as CustomWindow
    participant QC as QVsoaClient
    participant S as 服务器
    participant CD as CustomDashboard
    participant MW as MinimapWidget

    U->>CW: 启动程序
    CW->>QC: 初始化连接
    QC->>S: 连接请求
    S-->>QC: 连接确认
    QC-->>CW: 连接成功

    loop 数据接收循环
        S->>QC: 发送游戏数据
        QC->>CW: 数据到达
        CW->>CW: 解析JSON数据
        CW->>CD: 分发无人机数据
        CD->>MW: 更新地图显示
        MW-->>U: 显示更新
    end

    U->>MW: 点击无人机
    MW->>CD: 发送选择信号
    CD->>CW: 更新选中无人机
    CW->>QC: 发送控制命令
    QC->>S: 控制指令
    S-->>QC: 确认响应
```

## 障碍物管理流程图

```mermaid
graph TD
    A[接收障碍物数据] --> B{障碍物类型判断}

    B -->|山体/雷达| C[静态障碍物]
    B -->|雷云| D[动态障碍物]

    C --> E[永久保存到缩略图]
    D --> F[临时保存到缩略图]

    E --> G[绘制到地图]
    F --> H[设置过期时间]
    H --> G

    G --> I[定期清理检查]
    I --> J{是否过期}
    J -->|是| K[清除动态障碍物]
    J -->|否| L[保留显示]

    K --> M[更新地图显示]
    L --> M
```

## 无人机选择流程图

```mermaid
graph TD
    A[用户交互] --> B{交互方式}

    B -->|地图点击| C[MinimapWidget]
    B -->|下拉菜单| D[FlightControlWidget]
    B -->|程序接口| E[直接设置]

    C --> F[检测点击位置]
    F --> G{是否点击到无人机}
    G -->|是| H[获取无人机ID]
    G -->|否| I[忽略点击]

    D --> J[获取选中项]
    E --> K[设置无人机ID]

    H --> L[发送选择信号]
    J --> L
    K --> L

    L --> M[CustomDashboard接收]
    M --> N[更新选中状态]
    N --> O[通知所有组件]
    O --> P[更新UI显示]
```

## 控制命令流程图

```mermaid
graph TD
    A[用户控制输入] --> B{控制方式}

    B -->|键盘控制| C[CustomWindow键盘事件]
    B -->|摇杆控制| D[JoystickWidget]
    B -->|程序控制| E[API调用]

    C --> F[处理键盘事件]
    D --> G[计算摇杆角度和距离]
    E --> H[直接设置控制参数]

    F --> I[生成控制命令]
    G --> I
    H --> I

    I --> J[定时器触发发送]
    J --> K[QVsoaClient发送]
    K --> L[服务器接收]
    L --> M[服务器响应]
    M --> N[更新无人机状态]
```

## 数据更新时序图

```mermaid
sequenceDiagram
    participant Timer as 定时器
    participant CW as CustomWindow
    participant CD as CustomDashboard
    participant MW as MinimapWidget
    participant RW as RadarWidget
    participant CW2 as CompassWidget
    participant JW as JoystickWidget
    participant DSW as DroneStatusWidget

    Timer->>CW: 50ms定时触发
    CW->>CW: 处理控制命令
    CW->>CD: 更新数据
    CD->>MW: 更新地图
    CD->>RW: 更新雷达
    CD->>CW2: 更新指南针
    CD->>JW: 更新摇杆
    CD->>DSW: 更新状态

    par 并行更新
        MW->>MW: 重绘地图
        RW->>RW: 重绘雷达
        CW2->>CW2: 重绘指南针
        JW->>JW: 重绘摇杆
        DSW->>DSW: 重绘状态
    end
```

## 错误处理流程图

```mermaid
graph TD
    A[系统运行] --> B{检测到错误}

    B -->|通信错误| C[连接重试]
    B -->|数据错误| D[数据验证]
    B -->|UI错误| E[组件重置]
    B -->|内存错误| F[资源清理]

    C --> G{重试成功}
    G -->|是| H[恢复正常]
    G -->|否| I[降级模式]

    D --> J{数据有效}
    J -->|是| K[继续处理]
    J -->|否| L[使用默认值]

    E --> M[重新初始化组件]
    F --> N[释放资源]

    H --> O[继续运行]
    I --> P[显示错误信息]
    K --> O
    L --> O
    M --> O
    N --> O
    P --> Q[等待用户操作]
```

## 系统状态转换图

```mermaid
stateDiagram-v2
    [*] --> 初始化
    初始化 --> 连接中: 启动通信
    连接中 --> 运行中: 连接成功
    连接中 --> 错误状态: 连接失败
    运行中 --> 暂停: 用户暂停
    运行中 --> 错误状态: 系统错误
    暂停 --> 运行中: 用户恢复
    错误状态 --> 初始化: 重新启动
    错误状态 --> [*]: 退出程序
    运行中 --> [*]: 正常退出
```

## 性能监控图

```mermaid
graph LR
    A[性能监控] --> B[CPU使用率]
    A --> C[内存使用率]
    A --> D[网络延迟]
    A --> E[UI响应时间]

    B --> F[性能分析]
    C --> F
    D --> F
    E --> F

    F --> G{性能是否正常}
    G -->|是| H[继续运行]
    G -->|否| I[性能优化]

    I --> J[减少更新频率]
    I --> K[优化渲染]
    I --> L[清理缓存]

    J --> M[重新评估]
    K --> M
    L --> M
    M --> G
```

---

## 关键参数说明

### 定时器配置

- **控制定时器**: 50ms (20Hz)
- **更新定时器**: 50ms (20Hz)
- **雷达扫描**: 实时动画
- **障碍物清理**: 1 秒超时

### 地图配置

- **地图尺寸**: 1280x800 像素
- **缩放范围**: 0.3x - 2.0x
- **探测半径**: 300 像素
- **网格间距**: 50 像素

### 通信配置

- **协议**: QVsoa
- **数据格式**: JSON
- **重连机制**: 自动重连
- **超时设置**: 可配置

### 内存管理

- **基础内存**: ~50MB
- **动态增长**: 线性增长
- **缓存清理**: 自动清理
- **资源释放**: 程序退出时

---

_流程图版本: 1.0_  
_最后更新: 2024 年_
